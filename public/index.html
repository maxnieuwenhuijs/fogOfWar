<!DOCTYPE html>
<html lang="nl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fog of War - Multiplayer</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="replay-styles.css" />
  <!-- Inline styles hier zijn alleen voor referentie, ze moeten in style.css -->
  <style>
    /* Inline CSS hier is NIET AANBEVOLEN - Zet dit in style.css */
    /* Noodzakelijk voor de demo als style.css niet beschikbaar is */
    /* Zie het style.css blok hieronder voor de volledige CSS */
  </style>
</head>

<body>
  <!-- Game Stats Bar -->
  <div class="game-stats-bar">
    <div class="stats-content">
      <div class="stat-item">
        <span class="stat-value" id="stats-phase">WAITING</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Player:</span>
        <span class="stat-value" id="stats-player">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Cycle:</span>
        <span class="stat-value" id="stats-cycle">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Round:</span>
        <span class="stat-value" id="stats-round">-</span>
      </div>
    </div>
  </div>

  <!-- Lobby Screens -->
  <div id="lobby-screen" class="screen">
    <!-- Back to menu button -->
    <button id="lobby-back-btn" class="menu-button back" style="position: absolute; top: 15px; left: 15px; z-index: 100;">
      <span class="button-icon">‚¨ÖÔ∏è</span>
      <span class="button-text">Menu</span>
    </button>
    <!-- Removed original h1 here -->
    <div class="lobby-container">
      <!-- Top buttons row -->
      <div class="lobby-top-buttons">
        <button id="create-game-btn" class="lobby-action-btn">Create Game</button>
        <button id="show-join-game-btn" class="lobby-action-btn">Join Game</button>
      </div>
      
      <!-- Join game form (initially hidden) -->
      <div id="join-game-form" class="join-game-form" style="display: none;">
        <div class="form-row">
          <input type="text" id="room-code" placeholder="Enter 6-letter room code" />
          <button id="join-game-btn" class="primary-btn">Join</button>
          <button id="cancel-join-btn" class="secondary-btn">Cancel</button>
        </div>
      </div>
      
      <!-- Public visibility option for create game (initially hidden) -->
      <div id="create-game-options" class="create-game-options" style="display: none;">
        <h3>Create Game</h3>
        <div class="radio-group">
          <label><input type="radio" name="create-visibility" value="public" checked> Public (listed)</label>
          <label><input type="radio" name="create-visibility" value="private"> Private (join by code)</label>
        </div>
        <div class="form-row" style="margin-top: 15px; justify-content: center;">
          <button id="confirm-create-btn" class="primary-btn">Create</button>
          <button id="cancel-create-btn" class="secondary-btn">Cancel</button>
        </div>
      </div>
      
      <!-- Public games list -->
      <div class="lobby-games-list ui-panel">
        <div class="active-games-header">
          <h2>List with online games</h2>
          <button id="refresh-games-btn" class="refresh-btn" title="Refresh">üîÑ</button>
        </div>
        <ul id="active-games-list" class="active-games-list">
          <li>No public games available</li>
        </ul>
      </div>
    </div>

  </div>

  <div id="waiting-screen" class="screen">
    <h1>Waiting for Opponent</h1>
    <div class="waiting-container">
      <div class="room-info">
        <h2>
          Room Code:
          <span id="display-room-code" class="highlighted-code">------</span>
          <span class="copy-icon" title="Copy Room Code"
            onclick="copyRoomCodeToClipboard('display-room-code')">üìã</span>
        </h2>
        <p>Share this code with your opponent</p>
      </div>
      <div class="spinner"></div>
      <p id="waiting-message">Waiting for Player 2...</p>
    </div>
  </div>

  <div id="game-lobby-screen" class="screen">
    <h1>Game Lobby</h1>
    <div class="game-lobby-container">
      <div class="players-info">
        <div class="player-card" id="player1-card">
          <h3>Player 1</h3>
          <p id="player1-name">P1 Name</p>
          <div class="ready-status" id="player1-ready">Not Ready</div>
        </div>
        <div class="vs-label">VS</div>
        <div class="player-card" id="player2-card">
          <h3>Player 2</h3>
          <p id="player2-name">P2 Name</p>
          <div class="ready-status" id="player2-ready">Not Ready</div>
        </div>
      </div>
      <div class="room-details">
        <h3>
          Room Code:
          <span id="lobby-room-code" class="highlighted-code">------</span>
          <span class="copy-icon" title="Copy Room Code" onclick="copyRoomCodeToClipboard('lobby-room-code')">üìã</span>
        </h3>
      </div>
      <div class="lobby-actions">
        <button id="ready-btn" class="primary-btn">I'm Ready</button>
        <p id="game-status-message">Both players must be ready</p>
      </div>
    </div>
  </div>
  <!-- Einde Lobby Screens -->

  <!-- Game Screen -->
  <div id="game-screen" class="screen">
    <div class="mobile-topbar">
      <button id="btn-chat" class="topbar-btn" title="Chat">üí¨</button>
      <button id="btn-settings" class="topbar-btn" title="Settings">‚öôÔ∏è</button>
    </div>
    <div class="game-area">
      <!-- Left Column: Info + Chat + Medal -->
      <div id="left-column">
        <!-- Game Info Panel -->
        <div id="game-info-panel" class="ui-panel">
          <h3><span class="panel-icon">üó∫Ô∏è</span> Campaign Status</h3>

          <div id="player-info">
            <div id="player-indicator"></div>
            <span>You are General <span id="player-num">1</span> </span>
          </div>

          <hr>

          <!-- Pawn Count Display -->
          <div id="pawn-count-display">
            <h4>Regiment Count:</h4>
            <div class="pawn-count-row">
              <span class="player1-color">üî¥ Player 1:</span> <span id="p1-pawn-count">0</span>
            </div>
            <div class="pawn-count-row">
              <span class="player2-color">üîµ Player 2:</span> <span id="p2-pawn-count">0</span>
            </div>
          </div>

          <hr>

          <!-- Volume Slider -->
          <div class="volume-control">
            <label for="volume-slider"><span class="panel-icon">üîâ</span> Volume:</label>
            <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5">
            <span id="volume-value">50%</span>
          </div>

          <button id="mute-btn" class="action-button secondary-button"><span class="btn-icon">üîä</span> Mute
            Signals</button>
        </div>

        <!-- Chat Panel -->
        <div id="chat-panel" class="ui-panel">
          <h3><span class="panel-icon">üìú</span> War Council Chat</h3>
          <div id="chat-messages"></div>
          <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Issue Command..." />
            <button id="send-chat-btn" class="action-button"><span class="btn-icon">‚úâÔ∏è</span> Send</button>
          </div>
        </div>

        <!-- Medal indicator -->
        <div id="medal-container">
          <img id="p1-medal" src="assets/images/p1_medal.png" alt="Player 1's Turn" />
          <img id="p2-medal" src="assets/images/p2_medal.png" alt="Player 2's Turn" style="display: none;" />
        </div>
      </div>

      <!-- Center: Board -->
      <div class="board-and-cards-area">
        <div id="board-background-wrapper">
          <div class="board-background-layer"></div>
          <div id="game-container">
            <!-- Haven Cells -->
            <div class="haven-cell player-1-haven" style="grid-area: 1 / 1;"></div>
            <div class="haven-cell player-1-haven" style="grid-area: 1 / 3;"></div>
            <div class="haven-cell player-1-haven" style="grid-area: 1 / 5;"></div>
            <div class="haven-cell player-1-haven" style="grid-area: 1 / 7;"></div>
            <div class="haven-cell player-1-haven" style="grid-area: 1 / 9;"></div>
            <div class="haven-cell player-2-haven" style="grid-area: 11 / 1;"></div>
            <div class="haven-cell player-2-haven" style="grid-area: 11 / 3;"></div>
            <div class="haven-cell player-2-haven" style="grid-area: 11 / 5;"></div>
            <div class="haven-cell player-2-haven" style="grid-area: 11 / 7;"></div>
            <div class="haven-cell player-2-haven" style="grid-area: 11 / 9;"></div>
            <!-- PixiJS Canvas comes here (within game-container) -->
          </div>
        </div>
      </div>

      <!-- Right Column: Cards -->
      <div id="card-ui-area" class="ui-panel mobile-drawer">
        <div id="opponent-waiting" style="display: none">
          <h3><span class="panel-icon">‚è≥</span> Awaiting Opponent's Strategy</h3>
          <p>Hold position...</p>
          <div class="spinner small-spinner"></div>
        </div>
        <div id="card-definition-ui" style="display: none">
          <h3>
            <span class="panel-icon">‚ú®</span> Devise Tactics - Round <span id="def-round-num">1</span> (P
            <span id="def-player-num">1</span>)
          </h3>
          <div id="card-presets">
            <h4>Standard Formations:</h4>
            <div class="preset-buttons-container">
              <button id="preset-speedy" class="preset-button">
                Swift Scouts (1/5/1)
              </button>
              <button id="preset-attackers" class="preset-button">
                Shock Troops (3/1/3)
              </button>
              <button id="preset-defenders" class="preset-button">
                Iron Guard (4/1/2)
              </button>
            </div>
          </div>
          <p>Assign 7 points total (min 1 each) per unit.</p>
          <div class="card-input-grid">
            <div class="card-inputs">
              <h4>Unit 1</h4>
              <label>üõ°Ô∏è Resilience (HP):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card1-hp">‚ñº</button>
                  <input type="number" id="card1-hp" min="1" max="5" value="3" />
                  <button type="button" class="arrow-btn up" data-input="card1-hp">‚ñ≤</button>
                </div></label>
              <label>üêé March (Stamina):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card1-stamina">‚ñº</button>
                  <input type="number" id="card1-stamina" min="1" max="5" value="2" />
                  <button type="button" class="arrow-btn up" data-input="card1-stamina">‚ñ≤</button>
                </div></label>
              <label>‚öîÔ∏è Might (Attack):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card1-attack">‚ñº</button>
                  <input type="number" id="card1-attack" min="1" max="5" value="2" />
                  <button type="button" class="arrow-btn up" data-input="card1-attack">‚ñ≤</button>
                </div></label>
              <span class="card-sum" id="card1-sum">Total: 7</span>
            </div>
            <div class="card-inputs">
              <h4>Unit 2</h4>
              <label>üõ°Ô∏è Resilience (HP):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card2-hp">‚ñº</button>
                  <input type="number" id="card2-hp" min="1" max="5" value="2" />
                  <button type="button" class="arrow-btn up" data-input="card2-hp">‚ñ≤</button>
                </div></label>
              <label>üêé March (Stamina):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card2-stamina">‚ñº</button>
                  <input type="number" id="card2-stamina" min="1" max="5" value="3" />
                  <button type="button" class="arrow-btn up" data-input="card2-stamina">‚ñ≤</button>
                </div></label>
              <label>‚öîÔ∏è Might (Attack):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card2-attack">‚ñº</button>
                  <input type="number" id="card2-attack" min="1" max="5" value="2" />
                  <button type="button" class="arrow-btn up" data-input="card2-attack">‚ñ≤</button>
                </div></label>
              <span class="card-sum" id="card2-sum">Total: 7</span>
            </div>
            <div class="card-inputs">
              <h4>Unit 3</h4>
              <label>üõ°Ô∏è Resilience (HP):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card3-hp">‚ñº</button>
                  <input type="number" id="card3-hp" min="1" max="5" value="1" />
                  <button type="button" class="arrow-btn up" data-input="card3-hp">‚ñ≤</button>
                </div></label>
              <label>üêé March (Stamina):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card3-stamina">‚ñº</button>
                  <input type="number" id="card3-stamina" min="1" max="5" value="1" />
                  <button type="button" class="arrow-btn up" data-input="card3-stamina">‚ñ≤</button>
                </div></label>
              <label>‚öîÔ∏è Might (Attack):
                <div class="input-with-arrows">
                  <button type="button" class="arrow-btn down" data-input="card3-attack">‚ñº</button>
                  <input type="number" id="card3-attack" min="1" max="5" value="5" />
                  <button type="button" class="arrow-btn up" data-input="card3-attack">‚ñ≤</button>
                </div></label>
              <span class="card-sum" id="card3-sum">Total: 7</span>
            </div>
          </div>
          <button id="confirm-cards-btn" class="action-button confirm-button"><span class="btn-icon">‚úîÔ∏è</span>
            Finalize Orders</button>
        </div>
        <div id="card-reveal-ui" style="display: none">
          <h3><span class="panel-icon">üëÅÔ∏è</span> Orders Revealed - Round <span id="reveal-round-num">1</span></h3>
          <div class="players-cards">
            <div class="player-cards-section">
              <h4>Your Orders:</h4>
              <div id="your-revealed-cards" class="revealed-cards">
                <!-- Static Card Examples (will be replaced by JS) -->
                <div class="card-item player-1">
                  <strong class="card-title">Unit 1</strong>
                  <div class="card-stats">
                    <span><span class="icon hp-icon">üõ°Ô∏è</span> <span class="value">3</span></span>
                    <span><span class="icon speed-icon">üêé</span> <span class="value">2</span></span>
                    <span><span class="icon attack-icon">‚öîÔ∏è</span> <span class="value">2</span></span>
                  </div>
                </div>
                <div class="card-item player-1">
                  <strong class="card-title">Unit 2</strong>
                  <div class="card-stats">
                    <span><span class="icon hp-icon">üõ°Ô∏è</span> <span class="value">2</span></span>
                    <span><span class="icon speed-icon">üêé</span> <span class="value">3</span></span>
                    <span><span class="icon attack-icon">‚öîÔ∏è</span> <span class="value">2</span></span>
                  </div>
                </div>
                <!-- End Static Examples -->
              </div>
            </div>
            <div class="player-cards-section">
              <h4>Opponent's Orders:</h4>
              <div id="opponent-revealed-cards" class="revealed-cards">
                <!-- Static Card Examples (will be replaced by JS) -->
                <div class="card-item player-2">
                  <strong class="card-title">Unit 1</strong>
                  <div class="card-stats">
                    <span><span class="icon hp-icon">üõ°Ô∏è</span> <span class="value">4</span></span>
                    <span><span class="icon speed-icon">üêé</span> <span class="value">1</span></span>
                    <span><span class="icon attack-icon">‚öîÔ∏è</span> <span class="value">2</span></span>
                  </div>
                </div>
                <div class="card-item player-2">
                  <strong class="card-title">Unit 2</strong>
                  <div class="card-stats">
                    <span><span class="icon hp-icon">üõ°Ô∏è</span> <span class="value">1</span></span>
                    <span><span class="icon speed-icon">üêé</span> <span class="value">5</span></span>
                    <span><span class="icon attack-icon">‚öîÔ∏è</span> <span class="value">1</span></span>
                  </div>
                </div>
                <!-- End Static Examples -->
              </div>
            </div>
          </div>
          <div id="initiative-result">
            <h4><span class="panel-icon">‚≠ê</span> Initiative:</h4>
            <p>
              Player <span id="initiative-player">1</span> holds the initiative!
            </p>
            <p id="initiative-reason">(Superior Firepower: 9 vs 7)</p>
          </div>
        </div>
        <div id="linking-ui" style="display: none">
          <h3>
            <span class="panel-icon">üîó</span> Assign Units - Round <span id="link-round-num">1</span>, P
            <span id="link-player-num">1</span>
          </h3>
          <div id="available-cards-linking">
            <h4><span class="panel-icon">üÉè</span> Available Units:</h4>
            <div class="card-list-container">
              <!-- Static Card Examples (will be replaced by JS) -->
              <div class="card-item player-2 linked">
                <strong class="card-title">Opp Unit 1</strong>
                <div class="card-stats">
                  <span><span class="icon hp-icon">üõ°Ô∏è</span> <span class="value">4</span></span>
                  <span><span class="icon speed-icon">üêé</span> <span class="value">1</span></span>
                  <span><span class="icon attack-icon">‚öîÔ∏è</span> <span class="value">2</span></span>
                </div>
                <div class="linked-overlay">ASSIGNED</div>
              </div>
              <div class="card-item player-1 card-selected">
                <strong class="card-title">Your Unit 2</strong>
                <div class="card-stats">
                  <span><span class="icon hp-icon">üõ°Ô∏è</span> <span class="value">2</span></span>
                  <span><span class="icon speed-icon">üêé</span> <span class="value">3</span></span>
                  <span><span class="icon attack-icon">‚öîÔ∏è</span> <span class="value">2</span></span>
                </div>
              </div>
              <div class="card-item player-1">
                <strong class="card-title">Your Unit 3</strong>
                <div class="card-stats">
                  <span><span class="icon hp-icon">üõ°Ô∏è</span> <span class="value">1</span></span>
                  <span><span class="icon speed-icon">üêé</span> <span class="value">1</span></span>
                  <span><span class="icon attack-icon">‚öîÔ∏è</span> <span class="value">5</span></span>
                </div>
              </div>
              <!-- End Static Examples -->
            </div>
          </div>
          <div id="linking-status">Select an unassigned unit, then select a regiment on the map.</div>
        </div>

        <!-- Timer Display -->
        <div id="phase-timer" class="ui-timer" style="display: none;">
          ‚è≥ Time left: <span id="phase-timer-count">20</span>s
        </div>

        <!-- RPS Tiebreaker UI -->
        <div id="rps-tiebreaker-ui" style="display: none;">
          <h3><span class="panel-icon">‚öîÔ∏è</span> Initiative Duel! <span class="panel-icon">‚öîÔ∏è</span></h3>
          <p>Equal tactics measured! Settle the initiative with swift action!</p>
          <p id="rps-instruction" style="font-weight: bold;">Choose your Maneuver!</p>
          <div id="rps-buttons">
            <button id="rps-rock" class="rps-choice-btn action-button" data-choice="rock"
              title="Steadfast Defense (Rock)">ü™®</button>
            <button id="rps-paper" class="rps-choice-btn action-button" data-choice="paper"
              title="Enveloping Formation (Paper)">üìú</button>
            <button id="rps-scissors" class="rps-choice-btn action-button" data-choice="scissors"
              title="Flanking Attack (Scissors)">‚úÇÔ∏è</button>
          </div>
          <div id="rps-result">
            <!-- Results will be filled here -->
          </div>
        </div>

        <!-- Action UI -->
        <div id="action-ui" style="display: none">
          <h3><span class="panel-icon">‚öîÔ∏è</span> Action Phase (P <span id="action-player-num">1</span>)</h3>
          <div id="selected-pawn-info">Select a regiment to command.</div>
        </div>

        <!-- Epic Victory Screen -->
        <div id="game-over" style="display: none;">
          <div class="victory-container">
            <div class="victory-crown">üëë</div>
            <h2 class="victory-title">GLORIOUS VICTORY!</h2>
            <div class="victory-message">
              General <span id="winner-name">1</span> has conquered the battlefield!
            </div>
            <div class="victory-banner">
              <div class="victory-medal left"></div>
              <div class="victory-text">TRIUMPH</div>
              <div class="victory-medal right"></div>
            </div>
            <div class="victory-fireworks">
              <div class="firework" id="firework1"></div>
              <div class="firework" id="firework2"></div>
              <div class="firework" id="firework3"></div>
            </div>
            <div class="victory-actions">
              <button id="replay-btn" class="menu-button primary">Play Again</button>
              <button id="back-to-menu-btn" class="menu-button">Back to Menu</button>
            </div>
          </div>
        </div>
        
        <!-- Replay Request UI (Multiplayer) -->
        <div id="replay-request-ui" style="display: none;">
          <div class="replay-request-container">
            <h3>‚öîÔ∏è Rematch Request</h3>
            <p id="replay-request-message">Player <span id="requesting-player">?</span> wants to play again!</p>
            <div class="replay-request-actions">
              <button id="accept-replay-btn" class="menu-button primary">Accept</button>
              <button id="deny-replay-btn" class="menu-button secondary">Deny</button>
            </div>
            <p id="replay-waiting-message" style="display: none;">Waiting for opponent's response...</p>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- End of game-area -->
  </div>

  <!-- Toast notification -->
  <div id="toast-notification" class="toast-hidden">
    <div id="toast-message">Notification message</div>
  </div>

  <!-- Pawn Tooltip Element -->
  <div id="pawn-tooltip" class="tooltip" style="display: none; position: fixed; z-index: 100;">
    <!-- Content will be set by JS -->
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  
  <!-- <script src="/socket.io/socket.io.js"></script> -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"
    integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4"
    crossorigin="anonymous"></script>

  <!-- Prevent auto-connection -->
  <script>
    // Prevent Socket.IO from auto-connecting
    if (typeof io !== 'undefined') {
      io.defaults = { autoConnect: false };
    }
  </script>

  <!-- Game patch -->
  <script src="js/game-patch.js"></script>

  <!-- Game scripts -->
  <script src="js/game-constants.js"></script>
  <script src="js/game-classes.js"></script>
  <script src="js/sp-logger.js"></script>
  <script>
    // Enable singleplayer server logging to this app's endpoint
    window.SP_LOG_ENDPOINT = '/api/sp-log';
  </script>
  <script>
    // Default difficulty can be overridden later from menu
    try { if (window.SpLogger) SpLogger.setDifficulty(localStorage.getItem('sp_difficulty') || 'easy'); } catch (_) { }
  </script>
  <!-- Physics attack scripts removed -->
  <script src="js/sound-manager.js"></script>
  <script src="js/loading-screen.js"></script>
  <script src="js/menu-system.js"></script>
  <script src="js/lobby.js"></script>
  <script src="js/game-ui.js"></script>
  <script src="js/game-logic.js"></script>
  <script src="js/card-flip-fix.js"></script>
  <script src="js/singleplayer-simple.js"></script>
  <script src="js/singleplayer-victory-fix.js"></script>
  <script type="module" src="js/singleplayer-ai-patch.js"></script>
  <script src="js/main.js"></script>
  <script src="js/mobile-ui.js"></script>

  <script>
    // Wire victory actions when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
      const replayBtn = document.getElementById('replay-btn');
      const backBtn = document.getElementById('back-to-menu-btn');
      const replayRequestUI = document.getElementById('replay-request-ui');
      const acceptReplayBtn = document.getElementById('accept-replay-btn');
      const denyReplayBtn = document.getElementById('deny-replay-btn');
      const replayWaitingMsg = document.getElementById('replay-waiting-message');
      const replayRequestActions = document.querySelector('.replay-request-actions');
      
      if (replayBtn) {
        replayBtn.addEventListener('click', async function () {
          try {
            // Check if singleplayer or multiplayer
            if (gameState && gameState.singleplayerMode) {
              // Singleplayer: clean up and restart
              document.getElementById('game-over').style.display = 'none';
              
              // Clean up the previous game first
              if (typeof cleanupSingleplayer === 'function') {
                cleanupSingleplayer();
              }
              
              // Small delay to ensure cleanup completes
              await new Promise(resolve => setTimeout(resolve, 100));
              
              // Start new game
              if (typeof initSimpleSingleplayer === 'function') {
                await initSimpleSingleplayer();
              }
            } else {
              // Multiplayer: send replay request
              if (socket && gameSession && gameSession.roomCode) {
                socket.emit('replayRequest', { 
                  roomCode: gameSession.roomCode,
                  playerNum: gameState.playerNumber 
                });
                // Show waiting message in victory screen
                replayBtn.disabled = true;
                replayBtn.textContent = 'Waiting for opponent...';
              }
            }
          } catch (e) { 
            console.error('Replay failed', e); 
          }
        });
      }
      
      if (backBtn) {
        backBtn.addEventListener('click', function () {
          try {
            document.getElementById('game-over').style.display = 'none';
            if (replayRequestUI) replayRequestUI.style.display = 'none';
            
            // Clean up singleplayer if active
            if (gameState && gameState.singleplayerMode) {
              if (typeof cleanupSingleplayer === 'function') {
                cleanupSingleplayer();
              }
            }
            
            // For multiplayer, disconnect from room
            if (socket && gameSession && gameSession.roomCode && !gameState.singleplayerMode) {
              socket.emit('leaveRoom', { roomCode: gameSession.roomCode });
            }
            
            // Go back to menu
            if (typeof menuSystem !== 'undefined' && typeof menuSystem.showMainMenu === 'function') {
              menuSystem.showMainMenu();
            }
          } catch (e) { 
            console.warn('Back to menu failed', e); 
          }
        });
      }
      
      // Handle replay request acceptance
      if (acceptReplayBtn) {
        acceptReplayBtn.addEventListener('click', function () {
          if (socket && gameSession && gameSession.roomCode) {
            socket.emit('replayResponse', { 
              roomCode: gameSession.roomCode,
              accepted: true,
              playerNum: gameState.playerNumber
            });
            // Hide the request UI
            if (replayRequestUI) replayRequestUI.style.display = 'none';
          }
        });
      }
      
      // Handle replay request denial
      if (denyReplayBtn) {
        denyReplayBtn.addEventListener('click', function () {
          if (socket && gameSession && gameSession.roomCode) {
            socket.emit('replayResponse', { 
              roomCode: gameSession.roomCode,
              accepted: false,
              playerNum: gameState.playerNumber
            });
            // Hide the request UI
            if (replayRequestUI) replayRequestUI.style.display = 'none';
          }
        });
      }
      
      // Socket event handlers for replay system
      if (typeof socket !== 'undefined') {
        // When receiving a replay request from opponent
        socket.on('replayRequestReceived', function(data) {
          const requestingPlayer = data.playerNum;
          const requestingPlayerSpan = document.getElementById('requesting-player');
          if (requestingPlayerSpan) {
            requestingPlayerSpan.textContent = requestingPlayer;
          }
          // Show the replay request UI
          if (replayRequestUI) {
            replayRequestUI.style.display = 'block';
            // Make sure buttons are visible and waiting message is hidden
            if (replayRequestActions) replayRequestActions.style.display = 'flex';
            if (replayWaitingMsg) replayWaitingMsg.style.display = 'none';
          }
        });
        
        // When both players agreed to replay
        socket.on('replayAccepted', function() {
          console.log('Both players agreed to replay!');
          // Hide all UI elements
          document.getElementById('game-over').style.display = 'none';
          if (replayRequestUI) replayRequestUI.style.display = 'none';
          // The server will emit a new gameStart event
        });
        
        // When replay was denied
        socket.on('replayDenied', function(data) {
          const deniedBy = data.deniedBy;
          // Show message and go back to menu
          alert(`Player ${deniedBy} declined the rematch request.`);
          document.getElementById('game-over').style.display = 'none';
          if (replayRequestUI) replayRequestUI.style.display = 'none';
          
          // Disconnect and go to menu
          if (socket && gameSession && gameSession.roomCode) {
            socket.emit('leaveRoom', { roomCode: gameSession.roomCode });
          }
          
          if (typeof menuSystem !== 'undefined' && typeof menuSystem.showMainMenu === 'function') {
            menuSystem.showMainMenu();
          }
        });
      }
    });
  </script>

  <!-- Copy to Clipboard Functie -->
  <script>
    function copyRoomCodeToClipboard(elementId) {
      const codeElement = document.getElementById(elementId);
      if (!codeElement) {
        console.error(`Element with ID "${elementId}" not found.`);
        showToastMessage("Error finding room code.");
        return;
      }
      const roomCode = codeElement.textContent.trim();
      if (!roomCode || roomCode === "------") {
        console.warn("No valid room code.");
        showToastMessage("No room code yet.");
        return;
      }
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard
          .writeText(roomCode)
          .then(() => {
            console.log(`Copied: ${roomCode}`);
            showToastMessage(`Code "${roomCode}" copied!`);
          })
          .catch((err) => {
            console.error("Clipboard API failed:", err);
            showToastMessage("Copy failed. Trying fallback...");
            fallbackCopyText(roomCode);
          });
      } else {
        console.warn("Using fallback copy.");
        fallbackCopyText(roomCode);
      }
    }
    function fallbackCopyText(text) {
      const t = document.createElement("textarea");
      t.value = text;
      t.style.position = "fixed";
      t.style.opacity = "0";
      document.body.appendChild(t);
      t.focus();
      t.select();
      try {
        const s = document.execCommand("copy");
        showToastMessage(
          s ? `Code "${text}" copied (fallback).` : "Fallback copy failed."
        );
      } catch (err) {
        showToastMessage("Fallback copy error.");
      }
      document.body.removeChild(t);
    }
    function showToastMessage(message, duration = 2500) {
      const t = document.getElementById("toast-notification"),
        m = document.getElementById("toast-message");
      if (t && m) {
        if (
          typeof showToast === "function" &&
          showToast !== showToastMessage
        ) {
          showToast(message, duration);
        } else {
          m.textContent = message;
          t.classList.remove("toast-hidden");
          t.classList.add("toast-visible");
          setTimeout(() => {
            t.classList.remove("toast-visible");
            t.classList.add("toast-hidden");
          }, duration);
        }
      } else {
        alert(message);
      }
    }
  </script>
</body>

</html>